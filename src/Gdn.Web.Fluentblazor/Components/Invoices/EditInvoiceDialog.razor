@implements IDialogContentComponent<DialogContent>
@implements IDisposable

@inject IDialogService DialogService

<FluentDialogHeader ShowDismiss="true">
    <FluentStack VerticalAlignment="VerticalAlignment.Center">
        <FluentIcon Value="@(new Icons.Regular.Size24.WindowApps())" />
        <FluentLabel Typo="Typography.PaneHeader">
            @Dialog.Instance.Parameters.Title
        </FluentLabel>
    </FluentStack>
</FluentDialogHeader>

<FluentDialogBody>
    @if (Model is not null)
    {
        <EditForm EditContext="EditContext" FormName="edit-invoice-form">
            <DataAnnotationsValidator />
            <FluentGrid Spacing="1">
                <FluentGridItem xs="12" sm="3">
                    <FluentTextField Name="@nameof(InvoiceInputModel.Number)" @bind-Value="Model.Number" Label="Numero"
                                     Autofocus="true" Required="true" Style="width: 100%" />
                    <FluentValidationMessage For="@(() => Model.Number)" />
                </FluentGridItem>
                <FluentGridItem xs="12" sm="3">
                    <FluentDatePicker Name="@nameof(InvoiceInputModel.Date)" @bind-Value="Model.Date" Label="Data"
                                      Required="true" Style="width: 100%" />
                    <FluentValidationMessage For="@(() => Model.Date)" />
                </FluentGridItem>
                <FluentGridItem xs="12" sm="6">
                    <FluentCombobox Items=@Customers
                                    @bind-SelectedOption="SelectedCustomer"
                                    Required="true"
                                    OptionText="@(c => c?.Name)"
                                    Label="Cliente" Height="200px"
                                    Autocomplete="ComboboxAutocomplete.Both" Style="width: 100%" />
                    <FluentValidationMessage For="@(() => Model.CustomerId)" />
                </FluentGridItem>
                <FluentGridItem xs="12">
                    <FluentStack>
                        <FluentStack Orientation="Orientation.Vertical" Width="40px" Style="margin-top: 43px">
                            <FluentButton IconStart="@(new Icons.Regular.Size24.Add())" OnClick="AddRowClick" />
                        </FluentStack>
                        <FluentDataGrid Items="Model.Rows.AsQueryable()">
                            <PropertyColumn Property="@(p => p.Id)" />
                            <PropertyColumn Property="@(p => p.Description)" Title="Descrizione" />
                            <PropertyColumn Property="@(p => p.TaxRateId)" Title="Aliq.Iva" />
                            <PropertyColumn Property="@(p => p.MeasurementUnitId)" Title="Um" />
                            <PropertyColumn Property="@(p => p.Quantity)" Title="Quantità" Format="N2" Align="Align.End" />
                            <PropertyColumn Property="@(p => p.UnitPrice)" Title="Prezzo" Format="c" Align="Align.End" />
                            <PropertyColumn Property="@(p => p.TotalAmount)" Title="Totale" Format="c" Align="Align.End" />
                        </FluentDataGrid>
                    </FluentStack>

                </FluentGridItem>
            </FluentGrid>
        </EditForm>
    }
</FluentDialogBody>

<FluentDialogFooter>
    <FluentButton Appearance="Appearance.Accent"
                  OnClick="@SaveAsync">
        Salva
    </FluentButton>
</FluentDialogFooter>

@code {

    [Inject]
    private IHttpClientFactory HttpClientFactory { get; set; } = default!;

    [CascadingParameter]
    public FluentDialog Dialog { get; set; } = default!;

    [Parameter]
    public DialogContent Content { get; set; } = default!;

    private HttpClient HttpClient => HttpClientFactory.CreateApiClientVs();
    private InvoiceInputModel Model { get; set; } = default!;
    private EditContext EditContext { get; set; } = default!;

    IEnumerable<CustomerViewModel>? Customers;
    CustomerViewModel? SelectedCustomer;

    private ValidationMessageStore? _messageStore;

    protected override async Task OnInitializedAsync()
    {
        if (Content.Id == 0)
            Model = new InvoiceInputModel();
        else
        {
            string invoiceUri = $"invoices/{Content.Id}";
            Model = await HttpClient.GetFromJsonAsync<InvoiceInputModel>(invoiceUri) ?? new();
        }

        EditContext = new EditContext(Model);
        EditContext.OnValidationRequested += HandleValidationRequested;
        _messageStore = new(EditContext);

        string customersUri = "customers";
        Customers = await HttpClient.GetFromJsonAsync<IEnumerable<CustomerViewModel>>(customersUri)
            ?? Enumerable.Empty<CustomerViewModel>();
    }

    private async Task SaveAsync()
    {
        if (EditContext.Validate())
        {
            string uri = "invoices";
            if (!Model.Id.HasValue)
                await HttpClient.PostAsJsonAsync<InvoiceInputModel>(uri, Model);
            else
                await HttpClient.PutAsJsonAsync<InvoiceInputModel>(uri, Model);

            await Dialog.CloseAsync(Model);
        }
    }

    private void HandleValidationRequested(object? sender, ValidationRequestedEventArgs args)
    {
        _messageStore?.Clear();

        // Custom validation logic
    }

    public void Dispose()
    {
        if (EditContext is not null)
            EditContext.OnValidationRequested -= HandleValidationRequested;
    }

    private async Task AddRowClick(MouseEventArgs ea)
    {
        DialogContent content = new();
        DialogParameters parameters = new()
            {
                Title = $"Creazione riga fattura",
                PreventDismissOnOverlayClick = true,
                PreventScroll = true,
                TrapFocus = false,
                Width = "700px"
            };

        var dialog = await DialogService.ShowDialogAsync<EditInvoiceRowDialog>(content, parameters);
        var result = await dialog.Result;
        if (!result.Cancelled)
        {
            var rowModel = result.Data as InvoiceRowInputModel;
            if (rowModel is not null)
                Model.Rows.Add(rowModel);
        }
    }
}
